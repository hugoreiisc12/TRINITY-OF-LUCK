name: Deploy to Production

on:
  push:
    branches: [ main ]
  workflow_dispatch:
    inputs:
      environment:
        description: 'Deployment environment'
        required: true
        default: 'staging'
        type: choice
        options:
          - staging
          - production

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    environment:
      name: production
      url: https://api.trinity-of-luck.com
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'
    
    - name: Install dependencies
      run: npm ci
    
    - name: Run tests
      run: npm run test:unit
      env:
        NODE_ENV: test
        TEST_DATABASE_URL: postgresql://postgres:postgres@localhost:5432/trinity_test
        TEST_REDIS_URL: redis://localhost:6379/2
      continue-on-error: false
    
    - name: Build application
      run: npm run build
      env:
        NODE_ENV: production
    
    - name: Deploy to Railway
      env:
        RAILWAY_TOKEN: ${{ secrets.RAILWAY_TOKEN }}
      run: |
        npm i -g @railway/cli
        railway link --projectId ${{ secrets.RAILWAY_PROJECT_ID }}
        railway up --service ${{ secrets.RAILWAY_SERVICE_NAME }}
    
    - name: Health check
      run: |
        for i in {1..30}; do
          STATUS=$(curl -s -o /dev/null -w "%{http_code}" https://api.trinity-of-luck.com/health)
          if [ "$STATUS" = "200" ]; then
            echo "✓ Health check passed"
            exit 0
          fi
          echo "Attempt $i: Status $STATUS, retrying..."
          sleep 10
        done
        echo "✗ Health check failed"
        exit 1
    
    - name: Post deployment verification
      run: |
        echo "Verifying deployment..."
        curl -s https://api.trinity-of-luck.com/api/v1/health | jq '.'
    
    - name: Slack notification - Success
      if: success()
      uses: slackapi/slack-github-action@v1
      with:
        payload: |
          {
            "text": "✓ Deployment Successful",
            "blocks": [
              {
                "type": "section",
                "text": {
                  "type": "mrkdwn",
                  "text": "*Trinity API Gateway - Production Deployment*\n✓ Deployment Successful\nRef: ${{ github.ref }}\nCommit: ${{ github.sha }}"
                }
              }
            ]
          }
      env:
        SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
        SLACK_WEBHOOK_TYPE: INCOMING_WEBHOOK
    
    - name: Slack notification - Failure
      if: failure()
      uses: slackapi/slack-github-action@v1
      with:
        payload: |
          {
            "text": "✗ Deployment Failed",
            "blocks": [
              {
                "type": "section",
                "text": {
                  "type": "mrkdwn",
                  "text": "*Trinity API Gateway - Production Deployment*\n✗ Deployment Failed\nRef: ${{ github.ref }}\nCommit: ${{ github.sha }}\nCheck logs for details"
                }
              }
            ]
          }
      env:
        SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
        SLACK_WEBHOOK_TYPE: INCOMING_WEBHOOK
